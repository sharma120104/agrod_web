<!DOCTYPE html>
<html>
<head>
    <title>AGROD CONTROL</title>
    <meta charset="utf-8" />
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background:#fafafa;
        }
        img {
            border: 2px solid #333;
            width: 600px;
            height: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }
        #result {
            font-size: 18px;
            margin-top: 15px;
            padding: 10px;
            background:#EEE;
            width: 600px;
        }
    </style>
</head>
<body>

<h1>AGROD Drone Dashboard</h1>
<p><b>PI ID:</b> {{ pi_id }}</p>

<h2>Live Preview</h2>
<img id="live" src="/last_image/{{ pi_id }}">

<div id="result">
    {% if last_result %}
        Crop: {{ last_result.crop_type }} |
        Status: {{ last_result.status }} |
        Confidence: {{ last_result.confidence }}
    {% else %}
        No data yet
    {% endif %}
</div>

<h2>Controls</h2>
<button onclick="sendCommand('PUMP_ON')">Pump ON</button>
<button onclick="sendCommand('PUMP_OFF')">Pump OFF</button>
<button onclick="sendCommand('CAPTURE')">Capture Image</button>

<script>
const PI_ID = "{{ pi_id }}";
const REFRESH_MS = {{ refresh_interval }};

// send commands
function sendCommand(cmd){
    fetch("/api/set_command", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({pi_id: PI_ID, command: cmd})
    });
}

// Preload â†’ Swap image only after loading (no flicker)
function refreshImage(){
    const url = `/last_image/${PI_ID}?ts=` + Date.now();
    const img = new Image();
    img.onload = () => {
        document.getElementById("live").src = url;
    };
    img.onerror = () => {
        console.log("Preview load failed");
    };
    img.src = url;
}

// Refresh analysis result
function refreshResult(){
    fetch(`/api/last_result?pi_id=${PI_ID}`)
      .then(r => r.json())
      .then(j => {
          if (j.result){
              document.getElementById("result").innerText =
                  `Crop: ${j.result.crop_type} | Status: ${j.result.status} | Confidence: ${j.result.confidence}`;
          }
      });
}

// Combined loop
setInterval(() => {
    refreshImage();
    refreshResult();
}, REFRESH_MS);
</script>

</body>
</html>

