<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AGROD CONTROL</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    #live { border: 1px solid #ddd; display:block; margin-bottom:10px; }
    #controls { margin-bottom:12px; }
    #result { margin-top:10px; font-weight:600; }
  </style>
</head>
<body>
  <h1>AGROD Drone Dashboard</h1>

  <div id="controls">
    <button onclick="sendCommand('PUMP_ON')">Pump ON</button>
    <button onclick="sendCommand('PUMP_OFF')">Pump OFF</button>
    <button onclick="sendCommand('CAPTURE')">Capture Image</button>
    &nbsp; Current command: <span id="cmd">{{ command }}</span>
  </div>

  <h3>Live Preview</h3>
  <!-- Image will be refreshed frequently to mimic video -->
  <img id="live" src="/last_image/{{ pi_id }}?ts=0" width="640" height="360" alt="No image yet">

  <div id="result">
    {% if last_result %}
      Crop: {{ last_result.crop_type }} | Status: {{ last_result.status }} | Conf: {{ last_result.confidence }}
    {% else %}
      No data yet
    {% endif %}
  </div>

<script>
const PI_ID = "{{ pi_id }}";
let refreshing = true;
const REFRESH_MS = 500; // change to 250 for faster update, higher CPU/bandwidth

async function sendCommand(cmd){
  await fetch("/api/set_command", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({pi_id:PI_ID, command:cmd})
  });
  document.getElementById("cmd").innerText = cmd;
}

async function refreshResultAndImage(){
  // fetch last result
  try {
    const r = await fetch(`/api/last_result?pi_id=${PI_ID}`);
    const j = await r.json();
    const res = j.result;
    const resultDiv = document.getElementById("result");
    if (res) {
      resultDiv.innerText = `Crop: ${res.crop_type} | Status: ${res.status} | Conf: ${Number(res.confidence).toFixed(2)}`;
    }
  } catch(e){
    // ignore
  }

  // refresh image by changing query string to bust cache
  const img = document.getElementById("live");
  img.src = `/last_image/${PI_ID}?ts=${Date.now()}`;
}

setInterval(() => {
  if (refreshing) refreshResultAndImage();
}, REFRESH_MS);

</script>
</body>
</html>

