<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AGROD Drone Dashboard</title>
  <style>
    body{font-family:Arial, sans-serif;padding:18px;background:#fff}
    #preview{border:2px solid #222; width:640px; height:360px; display:block; object-fit:contain; background:#f7f7f7}
    #result{margin-top:10px; padding:8px; background:#efefef; width:640px}
    button{padding:8px 14px;margin:6px}
  </style>
</head>
<body>
  <h1>AGROD Drone Dashboard</h1>
  <p><b>PI ID:</b> {{ pi_id }}</p>

  <h2>Captured (latest)</h2>
  <img id="captured" src="/last_image/{{ pi_id }}" width="640" height="360" style="border:1px solid #ccc; display:block;">

  <h2>Near-live preview</h2>
  <!-- this image will be updated rapidly to mimic livestream -->
  <img id="preview" src="/last_image/{{ pi_id }}" alt="preview">

  <div id="result">
    {% if last_result %}
      Crop: {{ last_result.crop_type }} | Status: {{ last_result.status }} | Confidence: {{ last_result.confidence }}
    {% else %}
      No data yet
    {% endif %}
  </div>

  <h3>Controls</h3>
  <button onclick="sendCommand('PUMP_ON')">Pump ON</button>
  <button onclick="sendCommand('PUMP_OFF')">Pump OFF</button>
  <button onclick="sendCommand('CAPTURE')">Capture Image</button>

<script>
const PI_ID = "{{ pi_id }}";
const REFRESH_MS = {{ refresh_interval }}; // ms, set by app.py (250 default)

// send command to Pi (server will store it for Pi to poll)
function sendCommand(cmd){
  fetch("/api/set_command", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({pi_id:PI_ID, command:cmd})
  });
}

// reload captured image (manual refresh - used after upload)
function reloadCaptured(){
  document.getElementById("captured").src = `/last_image/${PI_ID}?ts=`+Date.now();
}

// near-live preview: preload image, swap when fully loaded
function refreshPreview(){
  const url = `/last_image/${PI_ID}?ts=` + Date.now();
  const img = new Image();
  img.onload = function(){ document.getElementById("preview").src = url; };
  img.onerror = function(){ /* ignore errors, keep previous frame */ };
  img.src = url;
}

// also refresh analysis result
function refreshResult(){
  fetch(`/api/last_result?pi_id=${PI_ID}`)
    .then(r=>r.json())
    .then(j=>{
      if (j.result){
        document.getElementById("result").innerText =
          `Crop: ${j.result.crop_type} | Status: ${j.result.status} | Confidence: ${j.result.confidence}`;
      }
    }).catch(()=>{});
}

// combined loop
setInterval(()=>{
  refreshPreview();
  refreshResult();
}, REFRESH_MS);

// optional: also reload the captured static display every few seconds so user-seen image updates
setInterval(reloadCaptured, REFRESH_MS*4); // slower than preview

</script>
</body>
</html>

